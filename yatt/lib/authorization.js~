/**
 * Install the middleware that verifies the user is logged in to be enabled to view restricted pages.
 * Only installed if app.config.site.private is set to true
 */
function initRankVerifier(app) {
    var _ = require('underscore');
    if(app.config.site.private){
        
        app.use(function(req, res, next){
            req.session.user  =  req.session.user || {};
            req.session.user.rank = req.session.user.rank || app.config.site.ranks.ANY;
            
            if(req.session.loggedIn){
                if(req.session.user.rank >= pagesRank[req.path]) //make sure user belongs
                {
                    next();
                }
                else{ // user is not allowed here!
                    req.session.loggedIn = false;
                    res.redirect('/'); //TODO handle breach attempt better
                }
            }
            else if(_.isEqual(pagesRank[req.path], app.config.site.ranks.ANY)){
                next();
            }
            else{
                res.redirect('/login?redirect=' + req.originalUrl);
            }
        });
	app.logger.info('Login verifier setup.');
    }
}

module.exports = initRankVerifier;
